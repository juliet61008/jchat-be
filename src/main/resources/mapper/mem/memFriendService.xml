<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jchat.mem.mapper.MemFriendMapper">
    <sql id="comUserRelationSelectFrom">
        select
            c1.user_no
             , c1.id
             , c1.name
             , b1.alias_nm
             , c1.birth
             , b1.like_yn
             , b1.block_yn
             , 'Y' as friend_yn
        from
            tbo_user a1
        left join
            tbo_user_relation b1
        on
            a1.user_no = b1.user_no
        inner join
            tbo_user c1
        on
            b1.relation_user_no = c1.user_no
        and c1.secn_yn = 'N'
    </sql>

    <select id="searchFriendList" resultType="com.jchat.mem.dto.ComOtherUser">
        /* [memFriendService.searchFriendList] 친구목록조회 [juliet61008/25.12.18]*/
        <include refid="comUserRelationSelectFrom" />
        where
            a1.user_no = #{userNo}
        order by
            case
                when b1.like_yn = 'Y' then 0
                else 1
            end asc
                ,
            case
                when c1.name ~ '^[가-힣]' then 1
                when c1.name ~ '^[A-Za-z]' then 2
                else 3
            end asc,
            LOWER(c1.name) asc
    </select>

    <insert id="insertFriend" parameterType="com.jchat.mem.dto.InsertFriendReqDto">
        /* [memFriendService.insertFriend] 친구 추가 [juliet61008/25.12.22]*/
        insert into tbo_user_relation
        (
            user_no
            , relation_user_no
            , like_yn
            , block_yn
            , create_tm
            , update_tm
            , alias_nm
        ) values (
            #{userNo}
            , #{relationUserNo}
            , coalesce(nullif(trim(#{likeYn}), ''), 'N')
            , coalesce(nullif(trim(#{blockYn}), ''), 'N')
            , now()
            , now()
            , null
        )
    </insert>

    <update id="updateFriend" parameterType="com.jchat.mem.dto.UpdateFriendReqDto">
        /* [memFriendService.updateFriend] 친구 상태 업데이트 [juliet61008/25.12.22]*/
        update
                tbo_user_relation
        set
                update_tm = now()
                <if test='null != likeYn and !"".equals(likeYn)'>
                    , like_yn = #{likeYn}
                </if>
                <if test='null != blockYn and !"".equals(blockYn)'>
                    , block_yn = #{blockYn}
                </if>
                <if test='null != aliasNm and !"".equals(aliasNm)'>
                    , alias_nm = #{aliasNm}
                </if>
        where
                user_no = #{userNo}
            and relation = #{relationUserNo}
    </update>

    <update id="mergeUserRelation" parameterType="com.jchat.mem.dto.MergeFriendReqDto">
        merge into tbo_relation as t
        using (select
                    #{userNo} as user_no
                    , #{relationUserNo} as relation_user_no)
            on t.user_no = s.user_no
            and t.relation_user_no = s.relation_user_no
        when matched then
        update set
            update_tm = now()
            <if test='null != likeYn and !"".equals(likeYn)'>
                , like_yn = #{likeYn}
            </if>
            <if test='null != blockYn and !"".equals(blockYn)'>
                , block_yn = #{blockYn}
            </if>
            <if test='null != aliasNm and !"".equals(aliasNm)'>
                , alias_nm = #{aliasNm}
            </if>
    </update>

</mapper>