<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jchat.chat.mapper.ChatMapper">

    <sql id="selectChatRoomMsg">
        msg_id
        , room_id
        , user_no
        , msg_content
        , msg_typ_cd
        , del_yn
        , create_tm
    </sql>

    <insert id="insertChatRoom" parameterType="com.jchat.chat.dto.InsertChatRoomReqDto">
        <selectKey keyProperty="roomId" resultType="long" order="BEFORE">
            SELECT nextval('seq_chat_room_id')
        </selectKey>

        insert into /* [chatService.insertChatRoom] 채팅방 베이스 삽입 [juliet61008/25.12.10] */
        tbo_chat_room (
            room_id
            , room_name
            , del_yn
            , room_cd
            , create_tm
            , update_tm
        ) values (
           #{roomId} /* room_id */
         , #{roomName} /* room_name */
         , 'N' /* del_yn */
         , '01' /* room_cd */
         , now() /* create_tm */
         , now() /* update_tm */
        )
    </insert>

    <insert id="insertChatRoomUser" parameterType="com.jchat.chat.dto.InsertChatRoomUserReqDto">
        insert into /* [chatService.insertChatRoomUser] 채팅방 유저 삽입 [juliet61008/25.12.10] */
        tbo_chat_room_user (
             room_id
           , user_no
           , join_yn
           , join_tm
           , unjoin_tm
           , create_tm
           , update_tm
        ) values (
              #{roomId} /* room_id */
            , #{userNo} /* user_no */
            , 'Y' /* join_yn */
            , now() /* join_tm */
            , null /* unjoin_tm */
            , now() /* create_tm */
            , now() /* update_tm */
        )
    </insert>

    <select id="selectChatRoomMsgSeq" resultType="java.lang.Long">
        /* [chatService.selectChatRoomMsgSeq] 채팅방 메세지 시퀀스 조회 [juliet61008/25.12.31] */
        select nextval('seq_chat_room_msg_id')
    </select>

    <insert id="insertChatRoomMsg" parameterType="com.jchat.chat.dto.InsertChatRoomMsgReqDto">
        /* [chatService.insertChatRoomUser] 채팅방 메세지 삽입 [juliet61008/25.12.10] */
        insert into
            tbo_chat_room_msg (
                msg_id
                , room_id
                , user_no
                , msg_content
                , msg_typ_cd
                , del_yn
                , del_tm
                , create_tm
                , update_tm
        ) values (
                #{msgId} /* msg_id */
                , #{roomId} /* room_id */
                , #{userNo} /* user_no */
                , #{msgContent} /* msg_content */
                , '01' /* msg_typ_cd */
                , 'N' /* del_yn */
                , null /* del_tm */
                , now() /* create_tm */
                , now() /* update_tm */
            )
    </insert>

    <update id="upsertChatRoomRead">
        /* [chatService.upsertChatRoomRead] 마지막 채팅방 조회 upsert [juliet61008/26.01.15] */
        INSERT INTO
            tbo_chat_room_read (
                                room_id
                               , user_no
                               , last_read_msg_id
                               , last_read_create_tm
                               , create_tm
                               , update_tm)
        VALUES (
                #{roomId}
               , #{userNo}
               , #{lastReadMsgId}
               , now()
               , now()
               , now()
               )
        ON CONFLICT (room_id, user_no)
        DO UPDATE SET
            last_read_msg_id = GREATEST(tbo_chat_room_read.last_read_msg_id, EXCLUDED.last_read_msg_id)
            , last_read_create_tm = GREATEST(tbo_chat_room_read.last_read_create_tm, EXCLUDED.last_read_create_tm)
            , update_tm = NOW()
    </update>

    <select id="searchChatRoomMsgByPk" resultType="com.jchat.chat.dto.ChatRoomMsg">
        /* [chatService.searchChatRoomMsgByPk] 채팅메세지정보 PK로 조회 [juliet61008/25.12.10] */
        select
            a1.room_id
             , b1.msg_id
             , c1.user_no as snd_user_no /* 발신자 회원번호 */
             , c1.name snd_name /* 발신자 성함 */
             , b1.msg_typ_cd
             , case
                   when b1.del_yn = 'Y'
                       then '삭제된 메세지 입니다.'
                   else b1.msg_content
            end as msg_content
             , case
                   when c1.user_no = #{userNo}
                       then 'Y'
                   else 'N'
            end as mine_yn
             , b1.del_yn
             , b1.create_tm
        from
            tbo_chat_room a1
                left join
            tbo_chat_room_msg b1
            on a1.room_id = b1.room_id
                left join tbo_user c1
                          on b1.user_no = c1.user_no
        where
              b1.msg_id = #{msgId}
          and a1.room_id = #{roomId}
          and a1.del_yn = 'N'
        order by
            b1.msg_id
    </select>

    <select id="searchChatRoomList" resultType="com.jchat.chat.dto.SearchChatRoomListResDto">
        /* [chatService.searchChatRoomList] 채팅방 리스트 조회 [juliet61008/26.01.02] */
        with wt_chat_room_user_mine as (
            select *
            from tbo_chat_room_user
            where user_no = #{userNo}
        )
       , wt_chat_room_msg_last as (
            select t1.room_id, t1.msg_id, t1.msg_content, t1.create_tm
            from tbo_chat_room_msg t1
                     join (
                            select room_id, max(msg_id) as max_msg_id
                            from tbo_chat_room_msg
                            group by room_id
                        ) t2 ON t1.room_id = t2.room_id AND t1.msg_id = t2.max_msg_id
        )
        select
            a2.room_id /* 채팅방 번호 */
            , a2.room_name /* 채팅방 이름 */
            , coalesce(nullif(trim(room_name), ''),
                       case
                           when nullif(
                                   (select trim(a3.room_alias_nm) from wt_chat_room_user_mine a3 where a3.room_id = a2.room_id)
                               , '') is not null
                           then (select trim(a3.room_alias_nm) from wt_chat_room_user_mine a3 where a3.room_id = a2.room_id)
                           when (select count(1) from tbo_chat_room_user a3 where a3.room_id = a2.room_id ) <![CDATA[ > ]]> 3
                               then  (
                               select string_agg(name, ', ') || ' 외 ' || ((select count(1) from tbo_chat_room_user where room_id = a2.room_id and join_yn = 'Y') - 3)::varchar || '명'
                               from (
                                        select coalesce(d1.alias_nm, c1.name) as name
                                        from tbo_chat_room_user b1
                                                 left join tbo_user c1 on c1.user_no = b1.user_no
                                                 left join tbo_user_relation d1 on d1.user_no = #{userNo} and c1.user_no = d1.relation_user_no
                                        where b1.room_id = a2.room_id
                                            limit 3
                                    ) limited
                           )
                           else string_agg(coalesce(a2.alias_nm, a2.name), ', ')
                           end
              ) as expo_room_name /* 노출 채팅방 이름 */
            , a2.room_cd /* 채팅방 코드 */
            , a2.like_yn /* 즐겨찾기 여부 */
            , a2.last_msg_content
            , a2.last_msg_create_tm
        from (
                select
                        a1.room_id
                      , a1.room_name
                      , b1.user_no
                      , a1.room_cd
                      , c1.name
                      , d1.alias_nm
                      , b1.like_yn
                      , e1.msg_content as last_msg_content
                      , e1.create_tm as last_msg_create_tm
                      , e1.msg_id as last_msg_id
                from
                    tbo_chat_room a1
                join
                    wt_chat_room_user_mine b1
                on
                    a1.room_id = b1.room_id
                left join
                    tbo_user c1 /* 유저목록 */
                on
                    c1.user_no = b1.user_no
                left join
                    tbo_user_relation d1
                on
                    d1.user_no = c1.user_no
                and c1.user_no = d1.relation_user_no
                join
                    wt_chat_room_msg_last e1
                on
                    e1.room_id = a1.room_id
             ) a2
        group by
            a2.room_id
            , a2.room_name
            , a2.room_cd
            , a2.like_yn
            , a2.last_msg_id
            , a2.last_msg_content
            , a2.last_msg_create_tm
        order by
            case
                when a2.like_yn = 'Y'
                    then 0
                else 1
                end /* 즐겨찾기 우선순위 먼저 */
               , a2.last_msg_id desc /* 최근 메세지 온 순서 */
    </select>

    <select id="searchChatRoomBasInfo" resultType="com.jchat.chat.dto.ChatRoom">
        /* [chatService.searchChatRoomBaseInfo] 채팅방 기본 정보 조회 [juliet61008/25.12.31] */
        select
            room_id
            , room_name
            , del_yn
            , room_cd
        from
            tbo_chat_room
        where
            room_id = #{roomId}
    </select>


    <select id="searchChatRoomUser" resultType="com.jchat.chat.dto.ChatRoomUser">
        /* [chatService.searchChatRoomUser] 채팅방 참여자 목록 조회 [juliet61008/25.12.15] */
        with wt_user_relation_mine as (
            select *
            from tbo_user_relation
            where user_no = #{userNo}
        )
        select
            c1.user_no
            , c1.name
            , case
                   when d1.user_no is not null
                       then 'Y'
                   else 'N'
            end as friend_yn
            , case
                   when c1.user_no = #{userNo}
                       then 'Y'
                   else 'N'
            end as mine_yn
            , e1.last_read_msg_id
        from tbo_chat_room a1
                 left join tbo_chat_room_user b1
                           on a1.room_id = b1.room_id
                 left join tbo_user c1
                           on b1.user_no = c1.user_no
                 left join wt_user_relation_mine d1
                           on c1.user_no = d1.relation_user_no
                 left join tbo_chat_room_read e1
                           on c1.user_no = e1.user_no
                          and a1.room_id = e1.room_id
        where a1.room_id = #{roomId}
          and a1.del_yn = 'N'
          and b1.join_yn = 'Y'
    </select>

    <select id="searchChatRoomMsg" resultType="com.jchat.chat.dto.ChatRoomMsg">
        /* [chatService.searchChatRoomMsg] 채팅방 메세지 정보 조회 [juliet61008/25.12.15] */
        select
                a1.room_id
                , b1.msg_id
                , c1.user_no as snd_user_no /* 발신자 회원번호 */
                , c1.name snd_name /* 발신자 성함 */
                , b1.msg_typ_cd
                , case
                    when b1.del_yn = 'Y'
                    then '삭제된 메세지 입니다.'
                    else b1.msg_content
                end as msg_content
                , case
                      when c1.user_no = #{userNo}
                          then 'Y'
                      else 'N'
                end as mine_yn
                , b1.del_yn
                , b1.create_tm
        from
                tbo_chat_room a1
        left join
                tbo_chat_room_msg b1
            on a1.room_id = b1.room_id
        left join tbo_user c1
            on b1.user_no = c1.user_no
        where
                a1.room_id = #{roomId}
            and a1.del_yn = 'N'
        order by
                b1.msg_id
    </select>

    <select id="searchExistsChatRoom" resultType="java.lang.String">
        /* [chatService.searchExistsChatRoom] 채팅방 유뮤 조회 [juliet61008/26.01.22] */
        with
            tbo_chat_room_mine as (
                select
                    a1.room_id
                from
                    tbo_chat_room a1
                        join tbo_chat_room_user b1
                             on
                                 a1.room_id = b1.room_id
                where
                    a1.del_yn = 'N'
                  and a1.room_cd = '01'
                  and b1.user_no = #{userNo})
                ,
            tbo_chat_room_friend as (
                select
                    a1.room_id
                from
                    tbo_chat_room a1
                        join tbo_chat_room_user b1
                             on
                                 a1.room_id = b1.room_id
                where
                    a1.del_yn = 'N'
                  and a1.room_cd = '01'
                  and b1.user_no = #{friendUserNo}
            )
        select
            case
                when exists (
                    select
                        1
                    from
                        tbo_chat_room_mine a1
                            join tbo_chat_room_friend b1
                                 on
                                     a1.room_id = b1.room_id)
                    then 'Y'
                else 'N'
                end
    </select>

</mapper>
