<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jchat.chat.mapper.ChatMapper">

    <sql id="selectChatRoomMsg">
        msg_id
        , room_id
        , user_no
        , msg_content
        , msg_typ_cd
        , del_yn
        , create_tm
    </sql>

    <insert id="insertChatRoom" parameterType="com.jchat.chat.dto.InsertChatRoomReqDto">
        <selectKey keyProperty="roomId" resultType="long" order="BEFORE">
            SELECT nextval('seq_chat_room_id')
        </selectKey>

        insert into /* [chatService.insertChatRoom] 채팅방 베이스 삽입 [juliet61008/25.12.10]*/
        tbo_chat_room (
            room_id
            , room_name
            , del_yn
            , room_cd
            , create_tm
            , update_tm
        ) values (
           #{roomId} /* room_id */
         , #{roomName} /* room_name */
         , 'N' /* del_yn */
         , '01' /* room_cd */
         , now() /* create_tm */
         , now() /* update_tm */
        )
    </insert>

    <insert id="insertChatRoomUser" parameterType="com.jchat.chat.dto.InsertChatRoomUserReqDto">
        insert into /* [chatService.insertChatRoomUser] 채팅방 유저 삽입 [juliet61008/25.12.10]*/
        tbo_chat_room_user (
             room_id
           , user_no
           , join_yn
           , join_tm
           , unjoin_tm
           , create_tm
           , update_tm
        ) values (
              #{roomId} /* room_id */
            , #{userNo} /* user_no */
            , 'Y' /* join_yn */
            , now() /* join_tm */
            , null /* unjoin_tm */
            , now() /* create_tm */
            , now() /* update_tm */
        )
    </insert>

    <insert id="insertChatRoomMsg" parameterType="com.jchat.chat.dto.InsertChatRoomMsgReqDto">
        <selectKey keyProperty="msgId" resultType="long" order="BEFORE">
            SELECT nextval('seq_chat_room_msg_id')
        </selectKey>

        insert into /* [chatService.insertChatRoomUser] 채팅방 유저 삽입 [juliet61008/25.12.10]*/
            tbo_chat_room_msg (
                msg_id
                , room_id
                , user_no
                , msg_content
                , msg_typ_cd
                , del_yn
                , del_tm
                , create_tm
                , update_tm
        ) values (
                #{msgId} /* msg_id */
                , #{roomId} /* room_id */
                , #{userNo} /* user_no */
                , #{msgContent} /* msg_content */
                , '01' /* msg_typ_cd */
                , 'N' /* del_yn */
                , null /* del_tm */
                , now() /* create_tm */
                , now() /* update_tm */
            )
    </insert>

    <select id="searchChatRoomMsgByPk" resultType="com.jchat.chat.dto.ChatRoomMsg">
        /* [chatService.searchChatRoomMsgByPk] 채팅메세지정보 PK로 조회 [juliet61008/25.12.10]*/
        select
            a1.room_id
             , b1.msg_id
             , c1.user_no as snd_user_no /* 발신자 회원번호 */
             , c1.name snd_name /* 발신자 성함 */
             , b1.msg_typ_cd
             , case
                   when b1.del_yn = 'Y'
                       then '삭제된 메세지 입니다.'
                   else b1.msg_content
            end as msg_content
             , case
                   when c1.user_no = #{userNo}
                       then 'Y'
                   else 'N'
            end as mine_yn
             , b1.del_yn
             , b1.create_tm
        from
            tbo_chat_room a1
                left join
            tbo_chat_room_msg b1
            on a1.room_id = b1.room_id
                left join tbo_user c1
                          on b1.user_no = c1.user_no
        where
              b1.msg_id = #{msgId}
          and a1.room_id = #{roomId}
          and a1.del_yn = 'N'
        order by
            b1.msg_id
    </select>

    <select id="searchChatRoomUser" resultType="com.jchat.chat.dto.ChatRoomUser">
        /* [chatService.searchChatRoomUser] 채팅방 참여자 목록 조회 [juliet61008/25.12.15]*/
        with wt_user_relation_mine as (
            select *
            from tbo_user_relation
            where user_no = #{userNo}
        )
        select
            c1.user_no
            , c1.name
            , case
                   when d1.user_no is not null
                       then 'Y'
                   else 'N'
            end as friend_yn
            , case
                   when c1.user_no = #{userNo}
                       then 'Y'
                   else 'N'
            end as mine_yn
        from tbo_chat_room a1
                 left join tbo_chat_room_user b1
                           on a1.room_id = b1.room_id
                 left join tbo_user c1
                           on b1.user_no = c1.user_no
                 left join wt_user_relation_mine d1
                           on c1.user_no = d1.relation_user_no
        where a1.room_id = #{roomId}
          and a1.del_yn = 'N'
          and b1.join_yn = 'Y'
    </select>

    <select id="searchChatRoomMsg" resultType="com.jchat.chat.dto.ChatRoomMsg">
        /* [chatService.searchChatRoomMsg] 채팅방 메세지 정보 조회 [juliet61008/25.12.15]*/
        select
                a1.room_id
                , b1.msg_id
                , c1.user_no as snd_user_no /* 발신자 회원번호 */
                , c1.name snd_name /* 발신자 성함 */
                , b1.msg_typ_cd
                , case
                    when b1.del_yn = 'Y'
                    then '삭제된 메세지 입니다.'
                    else b1.msg_content
                end as msg_content
                , case
                      when c1.user_no = #{userNo}
                          then 'Y'
                      else 'N'
                end as mine_yn
                , b1.del_yn
                , b1.create_tm
        from
                tbo_chat_room a1
        left join
                tbo_chat_room_msg b1
            on a1.room_id = b1.room_id
        left join tbo_user c1
            on b1.user_no = c1.user_no
        where
                a1.room_id = #{roomId}
            and a1.del_yn = 'N'
        order by
                b1.msg_id
    </select>

</mapper>
